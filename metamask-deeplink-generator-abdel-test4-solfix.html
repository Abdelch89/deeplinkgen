<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Generate secure MetaMask deeplinks for Home, Swap, and Buy with optional signing and pre-filled parameters." />
  <!-- CSP updated to allow ctfassets logo domain -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://images.ctfassets.net; connect-src 'none';">
  <title>MetaMask Deeplink Generator ‚Äî Home ‚Ä¢ Swap ‚Ä¢ Buy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
/* MetaMask Brand Colors & Enhanced Theme */
:root {
  --mm-orange: #F6851B;
  --mm-orange-light: #FFB84D;
  --mm-blue: #037DD6;
  --mm-blue-hover: #0260A4;
  --mm-green: #28A745;
  --mm-red: #D73A49;
  --bg: #F7F8FA;
  --card: #FFFFFF;
  --muted: #6A737D;
  --text: #24272A;
  --accent: #037DD6;
  --border: #D6D9DC;
  --shadow: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-hover: 0 4px 12px rgba(0,0,0,0.12);
  --gradient: linear-gradient(135deg, #037DD6 0%, #F6851B 100%);
}
@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0b0f14;
    --card: #121823;
    --muted: #8aa1b1;
    --text: #e9f0f5;
    --accent: #037DD6;
    --border: #1e2a36;
    --shadow: 0 2px 8px rgba(0,0,0,0.3);
    --shadow-hover: 0 4px 12px rgba(0,0,0,0.5);
  }
}
* { box-sizing: border-box; }
html, body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--text);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}
/* Header with MetaMask branding */
.header {
  background: var(--card);
  border-bottom: 1px solid var(--border);
  padding: 20px 0;
  margin-bottom: 24px;
  box-shadow: var(--shadow);
}
.header-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.logo {
  display: flex;
  align-items: center;
  gap: 12px;
}
.logo-img {
  width: 40px;
  height: 40px;
}
.wrap {
  max-width: 1200px;
  margin: 0 auto 24px;
  padding: 0 16px;
}
h1 {
  font-size: 28px;
  font-weight: 700;
  margin: 0;
  background: var(--gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
h2 {
  font-size: 18px;
  font-weight: 600;
  margin: 0 0 12px;
  color: var(--text);
}
p, li { color: var(--muted); }
.intro {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
}
.grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
}
@media (max-width: 980px) {
  .grid { grid-template-columns: 1fr; }
  h1 { font-size: 24px; }
}
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  box-shadow: var(--shadow);
  transition: all 0.3s ease;
}
.card:hover {
  box-shadow: var(--shadow-hover);
  transform: translateY(-2px);
}
label {
  display: block;
  margin: 8px 0 6px;
  color: var(--text);
  font-weight: 500;
  font-size: 13px;
}
select, input[type="text"], input[type="number"] {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1.5px solid var(--border);
  background: var(--card);
  color: var(--text);
  font-size: 14px;
  transition: all 0.2s ease;
  font-family: inherit;
}
select:focus, input[type="text"]:focus, input[type="number"]:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(3, 125, 214, 0.1);
}
input.error {
  border-color: var(--mm-red);
  background: rgba(215, 58, 73, 0.05);
}
.error-message {
  color: var(--mm-red);
  font-size: 12px;
  margin-top: 4px;
  display: none;
}
.error-message.show { display: block; }
.row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.btn {
  display: inline-flex;
  gap: 8px;
  align-items: center;
  justify-content: center;
  border: 1.5px solid var(--border);
  background: var(--card);
  color: var(--text);
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  font-size: 14px;
  transition: all 0.2s ease;
  font-family: inherit;
}
.btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
.btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
.btn.primary:hover { background: var(--mm-blue-hover); border-color: var(--mm-blue-hover); }
.btn.copy { background: linear-gradient(135deg, #037DD6 0%, #0260A4 100%); border: none; color: white; }
.btn.reset { background: var(--mm-orange); border-color: var(--mm-orange); color: white; }
.out {
  background: var(--bg);
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 12px;
  min-height: 48px;
  word-break: break-all;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  color: var(--text);
  transition: all 0.2s ease;
  position: relative;
}
.out:not(:empty) {
  border-style: solid;
  background: var(--card);
  border-color: var(--mm-green);
}
.muted { color: var(--muted); }
.small { font-size: 12px; }
.sigrow {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 12px;
  align-items: start;
  margin-top: 12px;
}
.checkbox-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
}
input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: var(--accent);
}
.foot {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
  color: var(--muted);
  font-size: 12px;
}
code {
  background: var(--bg);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 11px;
  color: var(--accent);
}
.warn {
  color: var(--mm-orange);
  font-size: 12px;
  margin-top: 8px;
  padding: 8px;
  background: rgba(246, 133, 27, 0.1);
  border-radius: 6px;
  border-left: 3px solid var(--mm-orange);
}
.btn-group {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  flex-wrap: wrap;
}
/* Toast notifications */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  padding: 12px 20px;
  border-radius: 8px;
  background: var(--card);
  border: 1px solid var(--border);
  box-shadow: var(--shadow-hover);
  transform: translateX(400px);
  transition: transform 0.3s ease;
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
}
.toast.show { transform: translateX(0); }
.toast-success { border-color: var(--mm-green); color: var(--mm-green); background: rgba(40, 167, 69, 0.1); }
.toast-error { border-color: var(--mm-red); color: var(--mm-red); background: rgba(215, 58, 73, 0.1); }
.toast-warning { border-color: var(--mm-orange); color: var(--mm-orange); background: rgba(246, 133, 27, 0.1); }
/* Loading animation */
.generating { position: relative; overflow: hidden; }
.generating::after {
  content: '';
  position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(3, 125, 214, 0.2), transparent);
  animation: loading 1.5s infinite;
}
@keyframes loading { 0% { left: -100%; } 100% { left: 100%; } }
/* Disclaimer section */
.disclaimer-section {
  margin-top: 32px; padding: 20px; background: var(--card);
  border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow);
}
.disclaimer-section h3 {
  font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text);
}
.disclaimer-section ul { list-style: none; padding: 0; }
.disclaimer-section li { padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
.disclaimer-section li:last-child { border-bottom: none; }
.disclaimer-section strong { color: var(--text); font-weight: 500; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <img src="https://images.ctfassets.net/clixtyxoaeas/1ezuBGezqfIeifWdVtwU4c/d970d4cdf13b163efddddd5709164d2e/MetaMask-icon-Fox.svg" alt="MetaMask Logo" class="logo-img" />
        <h1>MetaMask Deeplink Generator</h1>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="intro">
      <p class="muted">Generate secure deeplinks for MetaMask Home, Swap, and Buy features. Select your parameters and click Generate to create your custom deeplink URL.</p>
    </section>

    <section class="grid" aria-label="Deeplink Generators">
      <!-- HOME -->
      <article class="card" id="homeGen" aria-labelledby="home-title">
        <h2 id="home-title">üè† Home</h2>
        <div class="sigrow">
          <div class="checkbox-wrapper">
            <input id="homeSigned" type="checkbox" aria-controls="homeSig" aria-label="Use signed deeplink for Home" />
            <label for="homeSigned" style="margin:0;">Signed?</label>
          </div>
          <div>
            <input id="homeSig" type="text" disabled placeholder="Signature (sig) ‚Äî paste only if Signed is ON" aria-describedby="homeSigError" />
            <div class="error-message" id="homeSigError" role="alert"></div>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn primary" id="homeGenerate" aria-label="Generate Home deeplink">Generate</button>
          <button class="btn copy" id="homeCopy" aria-label="Copy Home deeplink">Copy</button>
          <button class="btn reset" id="homeReset" aria-label="Reset Home form">Reset</button>
        </div>
        <label style="margin-top: 12px">Constructed Deeplink URL</label>
        <div class="out" id="homeOut" aria-live="polite"></div>
        <div class="foot">Base URL: <code>https://link.metamask.io/home</code></div>
      </article>

      <!-- SWAP -->
      <article class="card" id="swapGen" aria-labelledby="swap-title">
        <h2 id="swap-title">üîÑ Swap</h2>
        <div class="row">
          <div>
            <label for="fromChain">From ‚Äî Chain</label>
            <select id="fromChain"></select>
          </div>
          <div>
            <label for="fromToken">From ‚Äî Token</label>
            <select id="fromToken"></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="toChain">To ‚Äî Chain</label>
            <select id="toChain"></select>
          </div>
          <div>
            <label for="toToken">To ‚Äî Token</label>
            <select id="toToken"></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="amountHuman">Amount (human units)</label>
            <input id="amountHuman" type="number" min="0" step="any" placeholder="e.g., 1" inputmode="decimal" aria-describedby="amountError" />
            <div class="error-message" id="amountError" role="alert"></div>
          </div>
          <div>
            <label class="muted" for="amountBase">Amount (base units) ‚Äî auto</label>
            <input id="amountBase" type="text" placeholder="auto-calculated" readonly />
          </div>
        </div>
        <div class="sigrow">
          <div class="checkbox-wrapper">
            <input id="swapSigned" type="checkbox" aria-controls="swapSig" aria-label="Use signed deeplink for Swap" />
            <label for="swapSigned" style="margin:0;">Signed?</label>
          </div>
          <div>
            <input id="swapSig" type="text" disabled placeholder="Signature (sig) ‚Äî paste only if Signed is ON" aria-describedby="swapSigError" />
            <div class="error-message" id="swapSigError" role="alert"></div>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn primary" id="swapGenerate" aria-label="Generate Swap deeplink">Generate</button>
          <button class="btn copy" id="swapCopy" aria-label="Copy Swap deeplink">Copy</button>
          <button class="btn reset" id="swapReset" aria-label="Reset Swap form">Reset</button>
        </div>
        <label style="margin-top: 12px">Constructed Deeplink URL</label>
        <div class="out" id="swapOut" aria-live="polite"></div>
        <div class="warn">‚ö†Ô∏è Only verified contract addresses are included. Contact support to add more tokens.</div>
        <div class="foot">Base URL: <code>https://link.metamask.io/swap</code></div>
      </article>

      <!-- BUY -->
      <article class="card" id="buyGen" aria-labelledby="buy-title">
        <h2 id="buy-title">üí≥ Buy</h2>
        <div class="sigrow">
          <div class="checkbox-wrapper">
            <input id="buySigned" type="checkbox" aria-controls="buySig" aria-label="Use signed deeplink for Buy" />
            <label for="buySigned" style="margin:0;">Signed?</label>
          </div>
          <div>
            <input id="buySig" type="text" disabled placeholder="Signature (sig) ‚Äî paste only if Signed is ON" aria-describedby="buySigError" />
            <div class="error-message" id="buySigError" role="alert"></div>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn primary" id="buyGenerate" aria-label="Generate Buy deeplink">Generate</button>
          <button class="btn copy" id="buyCopy" aria-label="Copy Buy deeplink">Copy</button>
          <button class="btn reset" id="buyReset" aria-label="Reset Buy form">Reset</button>
        </div>
        <label style="margin-top: 12px">Constructed Deeplink URL</label>
        <div class="out" id="buyOut" aria-live="polite"></div>
        <div class="foot">Base URL: <code>https://link.metamask.io/buy</code></div>
      </article>
    </section>

    <section class="disclaimer-section" aria-label="Important Information">
      <h3>üìã Important Information</h3>
      <ul>
        <li><strong>Routing behavior:</strong> Desktop with Extension installed ‚Üí opens Extension. Mobile with app ‚Üí opens app. Otherwise ‚Üí download page.</li>
        <li><strong>Signed vs unsigned:</strong> Signed deeplinks (with <code>sig</code> parameter) skip the "Proceed with caution" warning. Recommended for official use.</li>
        <li><strong>Minimum versions:</strong> Home: Extension ‚â•12.23.0, Mobile ‚â•7.51.0 | Swap: Extension ‚â•13.0.0, Mobile ‚â•7.51.0 | Buy: Extension ‚â•12.22.0, Mobile ‚â•7.51.0</li>
        <li><strong>Pre-population:</strong> Swap pre-fill requires Extension ‚â•13.0.0, Mobile ‚â•7.54.0. Buy pre-fill requires Extension ‚â•12.23.0, Mobile ‚â•7.54.0</li>
<li><strong>UTM tracking:</strong> Append standard UTM parameters (e.g., <code>&utm_source=...</code>) to any deeplink for analytics using the <a href="https://docs.google.com/spreadsheets/d/18MmwxQayfKmyMX1bDw3BSplzHnyV_bYBbStwnY84giE/edit?gid=1298904155#gid=1298904155" target="_blank" rel="noopener noreferrer">generator</a>.</li>
        <li><strong>Security:</strong> Only use signatures from trusted sources. Verify all parameters before sharing deeplinks.</li>
      </ul>
    </section>
  </main>

  <script>
/* ---------------- Networks ---------------- */
const CHAINS = [
  { key:'ethereum', label:'Ethereum Mainnet', ns:'eip155', chainId:1, slip:60 },
  { key:'polygon', label:'Polygon Mainnet', ns:'eip155', chainId:137, slip:966 },
  { key:'base', label:'Base', ns:'eip155', chainId:8453, slip:60 },
  { key:'arbitrum', label:'Arbitrum One', ns:'eip155', chainId:42161, slip:60 },
  { key:'optimism', label:'OP Mainnet', ns:'eip155', chainId:10, slip:60 },
  { key:'avalanche',label:'Avalanche C-Chain',ns:'eip155', chainId:43114, slip:9005 },
  { key:'bsc', label:'BNB Chain', ns:'eip155', chainId:56, slip:714 },
  { key:'linea', label:'Linea', ns:'eip155', chainId:59144, slip:60 },
  { key:'solana', label:'Solana Mainnet', ns:'solana', chainId:null, slip:501 },
];

/* ---------------- Tokens (verified only) ---------------- */
const TOKENS = {
  ethereum: [
    ['ETH','slip44','60',18],
    ['DAI','erc20','0x6B175474E89094C44Da98b954EedeAC495271d0F',18],
    ['USDC','erc20','0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',6],
    ['USDT','erc20','0xdAC17F958D2ee523a2206206994597C13D831ec7',6],
    ['WBTC','erc20','0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599',8],
    ['WETH','erc20','0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2',18],
    ['LINK','erc20','0x514910771AF9Ca656af840dff83E8264EcF986CA',18],
    ['UNI','erc20','0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984',18],
    ['AAVE','erc20','0x7Fc66500c84A76Ad7e9c93437bFc5Ac33E2DDaE9',18],
    ['PEPE','erc20','0x6982508145454Ce325dDbE47a25d4ec3d2311933',18],
  ],
  polygon: [
    ['POL','slip44','966',18],
    ['WETH','erc20','0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619',18],
  ],
  base: [
    ['ETH','slip44','60',18],
    ['USDC','erc20','0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',6],
    ['USDT','erc20','0xFDE4C96c8593536E31F229EA8f37B2aDa2699bB2',6],
  ],
  arbitrum: [
    ['ETH','slip44','60',18],
    ['USDC','erc20','0xAf88d065e77c8cC2239327C5EDb3A432268e5831',6],
  ],
  optimism: [
    ['ETH','slip44','60',18],
    ['USDC','erc20','0x0b2c639c533813f4aa9d7837caf62653d097ff85',6],
  ],
  avalanche: [
    ['AVAX','slip44','9005',18],
    ['WAVAX','erc20','0xB31f66AA3C1e785363F0875A1B74E27b85FD66c7',18],
  ],
  bsc: [
    ['BNB','slip44','714',18],
    ['USDC','erc20','0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d',18],
  ],
  linea: [
    ['ETH','slip44','60',18],
    ['USDC','erc20','0x176211869cA2b568f2A7D4EE941E073a821EE1ff',6],
    ['USDT','erc20','0xA219439258ca9da29E9Cc4cE5596924745e12B93',6],
    ['WETH','erc20','0xe5D7C2a44FfDDf6b295A15c148167daaAf5Cf34f',18],
    ['wstETH','erc20','0xB5beDd42000b71FddE22D3eE8a79Bd49A568fC8F',18],
    ['WBTC','erc20','0x3aAB2285ddcDdaD8edf438C1bAB47e1a9D05a9b4',8],
  ],
  solana: [
    ['SOL','slip44','501',9],
    ['USDC','mint','EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',6],
  ]
};

/* --------------- Helpers --------------- */
const $ = (id) => document.getElementById(id);

// Signature validation: accept 0x-hex (130 hex chars) OR Base64URL (A‚ÄìZ, a‚Äìz, 0‚Äì9, - and _), any length 40‚Äì200
const validate = {
  signature: (sig) => {
    if (!sig) return { valid: true, value: '' };
    const cleaned = sig.trim();
    // Accept 0x-prefixed hex of length 130
    const hex = cleaned.startsWith('0x') ? cleaned.slice(2) : cleaned;
    const isHex = /^[a-fA-F0-9]+$/.test(hex) && hex.length === 130;
    // Accept Base64URL (no padding required)
    const isB64Url = /^[A-Za-z0-9\-_]+$/.test(cleaned) && cleaned.length >= 40 && cleaned.length <= 200;
    if (!isHex && !isB64Url) {
      return { valid: false, error: 'Signature must be 0x-hex (130 chars) or Base64URL.' };
    }
    return { valid: true, value: cleaned };
  },
  amount: (value) => {
    if (!value) return { valid: true, value: '' };
    if (parseFloat(value) < 0) {
      return { valid: false, error: 'Amount must be positive' };
    }
    if (value.toString().toLowerCase().includes('e')) {
      return { valid: false, error: 'Scientific notation not allowed' };
    }
    return { valid: true, value };
  }
};

// Toast notifications
function showToast(message, type = 'success') {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 10);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Error messages
function showError(inputId, message) {
  const input = $(inputId);
  const errorEl = $(inputId + 'Error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.classList.add('show');
  }
  if (input) input.classList.add('error');
}
function clearError(inputId) {
  const input = $(inputId);
  const errorEl = $(inputId + 'Error');
  if (errorEl) errorEl.classList.remove('show');
  if (input) input.classList.remove('error');
}

function fillChains(sel) {
  sel.innerHTML = '';
  CHAINS.forEach(c => {
    const o = document.createElement('option');
    o.value = c.key;
    o.textContent = c.label;
    sel.appendChild(o);
  });
}
function tokensFor(chainKey) { return TOKENS[chainKey] || []; }
function fillTokens(sel, chainKey) {
  sel.innerHTML = '';
  const list = tokensFor(chainKey);
  list.forEach(([sym, type, addrOrSlip, dec]) => {
    const o = document.createElement('option');
    o.value = JSON.stringify({sym, type, addrOrSlip, dec});
    o.textContent = sym;
    sel.appendChild(o);
  });
  if (!list.length) {
    const o = document.createElement('option');
    o.value = '';
    o.textContent = '(no tokens)';
    sel.appendChild(o);
  }
}
function chainMeta(key) { return CHAINS.find(c => c.key === key); }
function toBaseUnits(amount, decimals) {
  if (!amount || isNaN(amount) || parseFloat(amount) < 0) return '';
  if (amount.toString().toLowerCase().includes('e')) return '';
  const [intPart, fracRaw = ''] = String(amount).split('.');
  const frac = (fracRaw + '0'.repeat(decimals)).slice(0, decimals);
  const joined = (intPart.replace(/\D/g, '') || '0') + frac;
  const base = joined.replace(/^0+/, '');
  return base === '' ? '0' : base;
}
function assetParam(tok) {
  if (!tok) return '';
  if (tok.type === 'slip44') return `slip44:${tok.addrOrSlip}`;
  if (tok.type === 'erc20') return `erc20:${tok.addrOrSlip}`;
  if (tok.type === 'mint') return `mint:${tok.addrOrSlip}`;
  return '';
}

/* --------------- Composers --------------- */
function composeHome() {
  let url = `https://link.metamask.io/home`;
  if ($('homeSigned').checked) {
    const sig = ($('homeSig').value || '').trim();
    const validation = validate.signature(sig);
    if (!validation.valid) { showError('homeSig', validation.error); return ''; }
    clearError('homeSig');
    if (sig) url += `?sig=${encodeURIComponent(sig)}`;
  }
  return url;
}
function composeSwap() {
  const fc = chainMeta($('fromChain').value);
  const tc = chainMeta($('toChain').value);
  if (!fc || !tc) return '';
  const ft = $('fromToken').value ? JSON.parse($('fromToken').value) : null;
  const tt = $('toToken').value ? JSON.parse($('toToken').value) : null;
  if (!ft || !tt) return '';
  const SOLANA_MAINNET_REF = '5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp';
  const nsFrom = fc.ns === 'solana' ? `solana:${SOLANA_MAINNET_REF}` : `eip155:${fc.chainId}`;
  const nsTo = tc.ns === 'solana' ? `solana:${SOLANA_MAINNET_REF}` : `eip155:${tc.chainId}`;
  const fromParam = assetParam(ft);
  const toParam = assetParam(tt);
  let url = `https://link.metamask.io/swap?from=${nsFrom}/${fromParam}&to=${nsTo}/${toParam}`;
  const human = $('amountHuman').value;
  if (human) {
    const validation = validate.amount(human);
    if (!validation.valid) { showError('amount', validation.error); return ''; }
    clearError('amount');
    const base = toBaseUnits(human, ft.dec);
    $('amountBase').value = base || '';
    if (base) url += `&amount=${base}`;
  } else { $('amountBase').value = ''; }
  if ($('swapSigned').checked) {
    const sig = ($('swapSig').value || '').trim();
    const validation = validate.signature(sig);
    if (!validation.valid) { showError('swapSig', validation.error); return ''; }
    clearError('swapSig');
    if (sig) url += `&sig=${encodeURIComponent(sig)}`;
  }
  return url;
}
function composeBuy() {
  let url = `https://link.metamask.io/buy`;
  if ($('buySigned').checked) {
    const sig = ($('buySig').value || '').trim();
    const validation = validate.signature(sig);
    if (!validation.valid) { showError('buySig', validation.error); return ''; }
    clearError('buySig');
    if (sig) url += `?sig=${encodeURIComponent(sig)}`;
  }
  return url;
}

// Enhanced copy with fallback
function copyToClipboard(text) {
  if (!text) { showToast('Nothing to copy', 'warning'); return; }
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text)
      .then(() => showToast('‚úì Copied to clipboard!', 'success'))
      .catch(() => fallbackCopy(text));
  } else { fallbackCopy(text); }
}
function fallbackCopy(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  try { document.execCommand('copy'); showToast('‚úì Copied to clipboard!', 'success'); }
  catch (err) { showToast('Failed to copy', 'error'); }
  document.body.removeChild(textarea);
}

// Reset functions
function resetHome() {
  $('homeSigned').checked = false;
  $('homeSig').value = '';
  $('homeOut').textContent = '';
  clearError('homeSig');
  showToast('Home form reset', 'success');
}
function resetSwap() {
  $('fromChain').value = 'polygon';
  $('toChain').value = 'ethereum';
  fillTokens($('fromToken'), 'polygon');
  fillTokens($('toToken'), 'ethereum');
  $('amountHuman').value = '';
  $('amountBase').value = '';
  $('swapSigned').checked = false;
  $('swapSig').value = '';
  $('swapOut').textContent = '';
  clearError('amount'); clearError('swapSig');
  showToast('Swap form reset', 'success');
}
function resetBuy() {
  $('buySigned').checked = false;
  $('buySig').value = '';
  $('buyOut').textContent = '';
  clearError('buySig');
  showToast('Buy form reset', 'success');
}

/* --------------- Wire up --------------- */
window.addEventListener('DOMContentLoaded', () => {
  ['fromChain', 'toChain'].forEach(id => fillChains($(id)));
  $('fromChain').value = 'polygon';
  $('toChain').value = 'ethereum';
  fillTokens($('fromToken'), $('fromChain').value);
  fillTokens($('toToken'), $('toChain').value);
  $('fromChain').addEventListener('change', () => fillTokens($('fromToken'), $('fromChain').value));
  $('toChain').addEventListener('change', () => fillTokens($('toToken'), $('toChain').value));
  $('amountHuman').addEventListener('input', (e) => {
    const value = e.target.value;
    if (value && parseFloat(value) < 0) {
      e.target.value = Math.abs(parseFloat(value));
      showToast('Negative values not allowed', 'warning');
    }
  });
  ['home', 'swap', 'buy'].forEach(type => {
    $(`${type}Generate`).addEventListener('click', () => {
      const outEl = $(`${type}Out`);
      outEl.classList.add('generating');
      setTimeout(() => {
        let url = '';
        if (type === 'home') url = composeHome();
        else if (type === 'swap') url = composeSwap();
        else if (type === 'buy') url = composeBuy();
        outEl.textContent = url;
        outEl.classList.remove('generating');
        if (url) showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} deeplink generated!`, 'success');
      }, 300);
    });
  });
  $('homeCopy').addEventListener('click', () => copyToClipboard($('homeOut').textContent.trim()));
  $('swapCopy').addEventListener('click', () => copyToClipboard($('swapOut').textContent.trim()));
  $('buyCopy').addEventListener('click', () => copyToClipboard($('buyOut').textContent.trim()));
  $('homeReset').addEventListener('click', resetHome);
  $('swapReset').addEventListener('click', resetSwap);
  $('buyReset').addEventListener('click', resetBuy);
  ['home', 'swap', 'buy'].forEach(type => {
    const checkbox = $(`${type}Signed`);
    const input = $(`${type}Sig`);
    checkbox.addEventListener('change', () => {
      input.disabled = !checkbox.checked;
      input.style.opacity = checkbox.checked ? '1' : '0.5';
      if (!checkbox.checked) { input.value = ''; clearError(`${type}Sig`); }
    });
    input.disabled = !checkbox.checked;
    input.style.opacity = checkbox.checked ? '1' : '0.5';
  });
});
  </script>
</body>
</html>

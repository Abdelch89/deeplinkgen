<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Generate secure MetaMask deeplinks for Home, Swap, and Buy with optional signing and pre-filled parameters.">
  <title>MetaMask Deeplink Generator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
:root {
  --mm-orange: #F6851B;
  --mm-blue: #037DD6;
  --mm-blue-hover: #0260A4;
  --mm-green: #28A745;
  --mm-red: #D73A49;
  --mm-solana: #9945FF;
  --mm-bitcoin: #F7931A;
  --mm-tron: #FF0013;

  --bg: #F7F8FA;
  --card: #FFFFFF;
  --muted: #6A737D;
  --text: #24272A;
  --accent: #037DD6;
  --border: #D6D9DC;
  --shadow: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-hover: 0 4px 12px rgba(0,0,0,0.12);
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0b0f14;
    --card: #121823;
    --muted: #8aa1b1;
    --text: #e9f0f5;
    --border: #1e2a36;
    --shadow: 0 2px 8px rgba(0,0,0,0.3);
    --shadow-hover: 0 4px 12px rgba(0,0,0,0.5);
  }
}

* { box-sizing: border-box; }

html, body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--text);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-size: 14px;
  line-height: 1.6;
}

.header {
  background: var(--card);
  border-bottom: 1px solid var(--border);
  padding: 20px 0;
  margin-bottom: 24px;
  box-shadow: var(--shadow);
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo-img { width: 40px; height: 40px; }

.wrap {
  max-width: 1200px;
  margin: 0 auto 24px;
  padding: 0 16px;
}

h1 {
  font-size: 24px;
  font-weight: 700;
  margin: 0;
  color: var(--accent);
}

h2 {
  font-size: 18px;
  font-weight: 600;
  margin: 0 0 12px;
  color: var(--text);
}

.intro {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  color: var(--muted);
}

.grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
}

@media (max-width: 980px) {
  .grid { grid-template-columns: 1fr; }
}

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  box-shadow: var(--shadow);
}

label {
  display: block;
  margin: 8px 0 6px;
  color: var(--text);
  font-weight: 500;
  font-size: 13px;
}

select, input[type="text"], input[type="number"] {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1.5px solid var(--border);
  background: var(--card);
  color: var(--text);
  font-size: 14px;
  font-family: inherit;
}

select:focus, input:focus {
  outline: none;
  border-color: var(--accent);
}

input:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.btn {
  display: inline-flex;
  gap: 8px;
  align-items: center;
  justify-content: center;
  border: none;
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  font-size: 14px;
  font-family: inherit;
  transition: all 0.2s ease;
}

.btn:hover { transform: translateY(-1px); }

.btn-primary {
  background: var(--accent);
  color: white;
}
.btn-primary:hover { background: var(--mm-blue-hover); }

.btn-copy {
  background: var(--mm-green);
  color: white;
}

.btn-reset {
  background: var(--mm-orange);
  color: white;
}

.btn-qr {
  background: #111827;
  color: white;
}

.btn-group {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.output {
  background: var(--bg);
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 12px;
  min-height: 48px;
  word-break: break-all;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  color: var(--text);
  margin-top: 12px;
}

.output.has-content {
  border-style: solid;
  border-color: var(--mm-green);
  background: var(--card);
}

.checkbox-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 12px;
}

.checkbox-row input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.checkbox-row label { margin: 0; cursor: pointer; }

.sig-input { margin-top: 8px; }

.warn {
  color: var(--mm-orange);
  font-size: 12px;
  margin-top: 8px;
  padding: 8px;
  background: rgba(246, 133, 27, 0.1);
  border-radius: 6px;
}

.foot {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
  color: var(--muted);
  font-size: 12px;
}

code {
  background: var(--bg);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 11px;
}

.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  padding: 12px 20px;
  border-radius: 8px;
  background: var(--mm-green);
  color: white;
  font-weight: 500;
  transform: translateX(400px);
  transition: transform 0.3s ease;
  z-index: 1000;
}

.toast.show { transform: translateX(0); }

.disclaimer {
  margin-top: 32px;
  padding: 20px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
}

.disclaimer h3 {
  font-size: 16px;
  margin: 0 0 12px;
}

.disclaimer ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.disclaimer li {
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
  color: var(--muted);
}

.disclaimer li:last-child { border-bottom: none; }

.qr-wrap {
  margin-top: 12px;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--bg);
  display: none;
}

.qr-wrap.show { display: block; }

.qr-row {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  flex-wrap: wrap;
}

.qr-canvas {
  background: white;
  padding: 10px;
  border-radius: 10px;
}

.qr-help {
  color: var(--muted);
  font-size: 12px;
  max-width: 320px;
}
  </style>
</head>

<body>
  <header class="header">
    <div class="header-content">
      <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask" class="logo-img">
      <h1>MetaMask Deeplink Generator</h1>
    </div>
  </header>

  <main class="wrap">
    <section class="intro">
      <p>Generate secure deeplinks for MetaMask Home, Swap, and Buy features. Select your parameters and click Generate. Swap now includes EVM, Solana, Bitcoin, and Tron formatting.</p>
    </section>

    <section class="grid">
      <!-- HOME CARD -->
      <article class="card">
        <h2>üè† Home</h2>

        <div class="checkbox-row">
          <input type="checkbox" id="homeSignedCheck">
          <label for="homeSignedCheck">Signed deeplink?</label>
        </div>

        <div class="sig-input">
          <input type="text" id="homeSigInput" placeholder="Paste signature here..." disabled>
        </div>

        <div class="btn-group">
          <button type="button" class="btn btn-primary" id="homeGenerateBtn">Generate</button>
          <button type="button" class="btn btn-copy" id="homeCopyBtn">Copy</button>
          <button type="button" class="btn btn-qr" id="homeQrBtn">QR</button>
          <button type="button" class="btn btn-reset" id="homeResetBtn">Reset</button>
        </div>

        <div class="output" id="homeOutput"></div>

        <div class="qr-wrap" id="homeQrWrap">
          <div class="qr-row">
            <canvas class="qr-canvas" id="homeQrCanvas" width="196" height="196"></canvas>
            <div class="qr-help">Scan on mobile to open the deeplink. If MetaMask is not installed, you may be routed to a download page.</div>
          </div>
        </div>

        <div class="foot">Base: <code>https://link.metamask.io/home</code></div>
      </article>

      <!-- SWAP CARD -->
      <article class="card">
        <h2>üîÑ Swap</h2>

        <div class="row">
          <div>
            <label for="fromChainSelect">From Chain</label>
            <select id="fromChainSelect"></select>
          </div>
          <div>
            <label for="fromTokenSelect">From Token</label>
            <select id="fromTokenSelect"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="toChainSelect">To Chain</label>
            <select id="toChainSelect"></select>
          </div>
          <div>
            <label for="toTokenSelect">To Token</label>
            <select id="toTokenSelect"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="amountInput">Amount</label>
            <input type="number" id="amountInput" min="0" step="any" placeholder="e.g., 1.5">
          </div>
          <div>
            <label>Base Units (auto)</label>
            <input type="text" id="baseUnitsDisplay" readonly placeholder="Calculated">
          </div>
        </div>

        <div class="checkbox-row">
          <input type="checkbox" id="swapSignedCheck">
          <label for="swapSignedCheck">Signed deeplink?</label>
        </div>

        <div class="sig-input">
          <input type="text" id="swapSigInput" placeholder="Paste signature here..." disabled>
        </div>

        <div class="btn-group">
          <button type="button" class="btn btn-primary" id="swapGenerateBtn">Generate</button>
          <button type="button" class="btn btn-copy" id="swapCopyBtn">Copy</button>
          <button type="button" class="btn btn-qr" id="swapQrBtn">QR</button>
          <button type="button" class="btn btn-reset" id="swapResetBtn">Reset</button>
        </div>

        <div class="output" id="swapOutput"></div>

        <div class="qr-wrap" id="swapQrWrap">
          <div class="qr-row">
            <canvas class="qr-canvas" id="swapQrCanvas" width="196" height="196"></canvas>
            <div class="qr-help">If a given pair is not routable, MetaMask may show no route available. This generator still formats the deeplink parameters correctly.</div>
          </div>
        </div>

        <div class="warn">‚ö†Ô∏è Only verified token addresses included (where applicable). Cross chain routing depends on MetaMask support.</div>
        <div class="foot">Base: <code>https://link.metamask.io/swap</code></div>
      </article>

      <!-- BUY CARD -->
      <article class="card">
        <h2>üí≥ Buy</h2>

        <div class="checkbox-row">
          <input type="checkbox" id="buySignedCheck">
          <label for="buySignedCheck">Signed deeplink?</label>
        </div>

        <div class="sig-input">
          <input type="text" id="buySigInput" placeholder="Paste signature here..." disabled>
        </div>

        <div class="btn-group">
          <button type="button" class="btn btn-primary" id="buyGenerateBtn">Generate</button>
          <button type="button" class="btn btn-copy" id="buyCopyBtn">Copy</button>
          <button type="button" class="btn btn-qr" id="buyQrBtn">QR</button>
          <button type="button" class="btn btn-reset" id="buyResetBtn">Reset</button>
        </div>

        <div class="output" id="buyOutput"></div>

        <div class="qr-wrap" id="buyQrWrap">
          <div class="qr-row">
            <canvas class="qr-canvas" id="buyQrCanvas" width="196" height="196"></canvas>
            <div class="qr-help">Use QR for quick handoff to mobile, especially when you are generating links on desktop.</div>
          </div>
        </div>

        <div class="foot">Base: <code>https://link.metamask.io/buy</code></div>
      </article>
    </section>

    <section class="disclaimer">
      <h3>üìã Important Information</h3>
      <ul>
        <li><strong>Routing:</strong> Desktop with Extension ‚Üí opens Extension. Mobile with app ‚Üí opens app. Otherwise ‚Üí download page.</li>
        <li><strong>Signed links:</strong> Skip the "Proceed with caution" warning. Recommended for official use.</li>
        <li><strong>Versions:</strong> Home: Ext ‚â•12.23.0, Mobile ‚â•7.51.0 | Swap: Ext ‚â•13.0.0, Mobile ‚â•7.51.0</li>
      </ul>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <script>
    // ===== DATA =====
    var CHAINS = [
      // EVM
      { key: 'ethereum', label: 'Ethereum', type: 'evm', ns: 'eip155', chainId: 1, slip: 60 },
      { key: 'polygon', label: 'Polygon', type: 'evm', ns: 'eip155', chainId: 137, slip: 966 },
      { key: 'base', label: 'Base', type: 'evm', ns: 'eip155', chainId: 8453, slip: 60 },
      { key: 'arbitrum', label: 'Arbitrum', type: 'evm', ns: 'eip155', chainId: 42161, slip: 60 },
      { key: 'optimism', label: 'Optimism', type: 'evm', ns: 'eip155', chainId: 10, slip: 60 },
      { key: 'avalanche', label: 'Avalanche', type: 'evm', ns: 'eip155', chainId: 43114, slip: 9005 },
      { key: 'bsc', label: 'BNB Chain', type: 'evm', ns: 'eip155', chainId: 56, slip: 714 },
      { key: 'linea', label: 'Linea', type: 'evm', ns: 'eip155', chainId: 59144, slip: 60 },

      // Solana
      { key: 'solana', label: 'Solana', type: 'solana', ns: 'solana', chainId: '5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp', slip: 501 },

      // Bitcoin
      { key: 'bitcoin', label: 'Bitcoin', type: 'bitcoin', ns: 'bip122', chainId: '000000000019d6689c085ae165831e93', slip: 0 },

      // Tron
      { key: 'tron', label: 'Tron', type: 'tron', ns: 'tron', chainId: '0x2b6653dc', slip: 195 }
    ];

    var TOKENS = {
      ethereum: [
        { sym: 'ETH', type: 'slip44', addr: '60', dec: 18 },
        { sym: 'USDC', type: 'erc20', addr: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', dec: 6 },
        { sym: 'USDT', type: 'erc20', addr: '0xdAC17F958D2ee523a2206206994597C13D831ec7', dec: 6 },
        { sym: 'DAI', type: 'erc20', addr: '0x6B175474E89094C44Da98b954EedeAC495271d0F', dec: 18 },
        { sym: 'WETH', type: 'erc20', addr: '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2', dec: 18 },
        { sym: 'WBTC', type: 'erc20', addr: '0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599', dec: 8 }
      ],
      polygon: [
        { sym: 'POL', type: 'slip44', addr: '966', dec: 18 },
        { sym: 'USDC', type: 'erc20', addr: '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359', dec: 6 },
        { sym: 'USDT', type: 'erc20', addr: '0xc2132D05D31c914a87C6611C10748AEb04B58e8F', dec: 6 },
        { sym: 'WETH', type: 'erc20', addr: '0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619', dec: 18 }
      ],
      base: [
        { sym: 'ETH', type: 'slip44', addr: '60', dec: 18 },
        { sym: 'USDC', type: 'erc20', addr: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913', dec: 6 }
      ],
      arbitrum: [
        { sym: 'ETH', type: 'slip44', addr: '60', dec: 18 },
        { sym: 'USDC', type: 'erc20', addr: '0xAf88d065e77c8cC2239327C5EDb3A432268e5831', dec: 6 },
        { sym: 'ARB', type: 'erc20', addr: '0x912CE59144191C1204E64559FE8253a0e49E6548', dec: 18 }
      ],
      optimism: [
        { sym: 'ETH', type: 'slip44', addr: '60', dec: 18 },
        { sym: 'USDC', type: 'erc20', addr: '0x0b2c639c533813f4aa9d7837caf62653d097ff85', dec: 6 },
        { sym: 'OP', type: 'erc20', addr: '0x4200000000000000000000000000000000000042', dec: 18 }
      ],
      avalanche: [
        { sym: 'AVAX', type: 'slip44', addr: '9005', dec: 18 },
        { sym: 'USDC', type: 'erc20', addr: '0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E', dec: 6 }
      ],
      bsc: [
        { sym: 'BNB', type: 'slip44', addr: '714', dec: 18 },
        { sym: 'USDT', type: 'erc20', addr: '0x55d398326f99059fF775485246999027B3197955', dec: 18 }
      ],
      linea: [
        { sym: 'ETH', type: 'slip44', addr: '60', dec: 18 },
        { sym: 'USDC', type: 'erc20', addr: '0x176211869cA2b568f2A7D4EE941E073a821EE1ff', dec: 6 }
      ],
      solana: [
        { sym: 'SOL', type: 'slip44', addr: '501', dec: 9 },
        { sym: 'USDC', type: 'spl', addr: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', dec: 6 },
        { sym: 'USDT', type: 'spl', addr: 'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB', dec: 6 }
      ],
      bitcoin: [
        { sym: 'BTC', type: 'slip44', addr: '0', dec: 8 }
      ],
      tron: [
        { sym: 'TRX', type: 'slip44', addr: '195', dec: 6 },
        { sym: 'USDT', type: 'trc20', addr: 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t', dec: 6 },
        { sym: 'USDC', type: 'trc20', addr: 'TEkxiTehnzSmSe2XqrBj4w32RUN966rdz8', dec: 6 }
      ]
    };

    // ===== HELPERS =====
    function getEl(id) { return document.getElementById(id); }

    function showToast(msg) {
      var toast = getEl('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(function() { toast.classList.remove('show'); }, 2500);
    }

    function copyText(text) {
      if (!text) { showToast('Nothing to copy!'); return; }
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(function() { showToast('Copied!'); })
          .catch(function() { showToast('Copy failed'); });
      } else {
        var ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); showToast('Copied!'); }
        catch (e) { showToast('Copy failed'); }
        document.body.removeChild(ta);
      }
    }

    function toBaseUnits(amount, decimals) {
      if (!amount || isNaN(parseFloat(amount))) return '';
      var num = parseFloat(amount);
      if (num < 0) return '';

      if (String(amount).toLowerCase().indexOf('e') !== -1) return '';

      var parts = String(amount).split('.');
      var intPart = parts[0] || '0';
      var fracPart = parts[1] || '';
      fracPart = (fracPart + '0'.repeat(decimals)).slice(0, decimals);

      var result = (intPart.replace(/\D/g, '') + fracPart.replace(/\D/g, '')).replace(/^0+/, '');
      return result || '0';
    }

    function getChain(key) {
      for (var i = 0; i < CHAINS.length; i++) {
        if (CHAINS[i].key === key) return CHAINS[i];
      }
      return null;
    }

    function populateChains(selectEl) {
      selectEl.innerHTML = '';
      for (var i = 0; i < CHAINS.length; i++) {
        var opt = document.createElement('option');
        opt.value = CHAINS[i].key;
        opt.textContent = CHAINS[i].label;
        selectEl.appendChild(opt);
      }
    }

    function populateTokens(selectEl, chainKey) {
      selectEl.innerHTML = '';
      var tokens = TOKENS[chainKey] || [];
      for (var i = 0; i < tokens.length; i++) {
        var opt = document.createElement('option');
        opt.value = i;
        opt.textContent = tokens[i].sym;
        selectEl.appendChild(opt);
      }
      if (tokens.length === 0) {
        var opt2 = document.createElement('option');
        opt2.value = '';
        opt2.textContent = '(none)';
        selectEl.appendChild(opt2);
      }
    }

    function getNamespaceString(chain) {
      return chain.ns + ':' + chain.chainId;
    }

    function getAssetString(token) {
      if (token.type === 'slip44') return 'slip44:' + token.addr;
      if (token.type === 'erc20') return 'erc20:' + token.addr;
      if (token.type === 'spl') return 'spl:' + token.addr;
      if (token.type === 'trc20') return 'trc20:' + token.addr;
      return '';
    }

    function clearCanvas(canvas) {
      if (!canvas) return;
      var ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function renderQr(canvasId, wrapId, text) {
      var canvas = getEl(canvasId);
      var wrap = getEl(wrapId);
      if (!canvas || !wrap) return;

      if (!text) {
        clearCanvas(canvas);
        wrap.classList.remove('show');
        return;
      }

      wrap.classList.add('show');

      try {
        QRCode.toCanvas(canvas, text, {
          width: 196,
          margin: 1
        }, function(err) {
          if (err) {
            showToast('QR generation failed');
            clearCanvas(canvas);
          }
        });
      } catch (e) {
        showToast('QR generation failed');
        clearCanvas(canvas);
      }
    }

    // ===== HOME =====
    function initHome() {
      var checkbox = getEl('homeSignedCheck');
      var sigInput = getEl('homeSigInput');
      var genBtn = getEl('homeGenerateBtn');
      var copyBtn = getEl('homeCopyBtn');
      var qrBtn = getEl('homeQrBtn');
      var resetBtn = getEl('homeResetBtn');
      var output = getEl('homeOutput');

      checkbox.addEventListener('change', function() {
        sigInput.disabled = !checkbox.checked;
        if (!checkbox.checked) sigInput.value = '';
      });

      genBtn.addEventListener('click', function() {
        var url = 'https://link.metamask.io/home';
        if (checkbox.checked && sigInput.value.trim()) {
          url += '?sig=' + encodeURIComponent(sigInput.value.trim());
        }
        output.textContent = url;
        output.classList.add('has-content');
        renderQr('homeQrCanvas', 'homeQrWrap', url);
        showToast('Home deeplink generated!');
      });

      copyBtn.addEventListener('click', function() { copyText(output.textContent); });

      qrBtn.addEventListener('click', function() {
        var url = output.textContent || '';
        if (!url) { showToast('Generate a link first'); return; }
        renderQr('homeQrCanvas', 'homeQrWrap', url);
        showToast('QR ready');
      });

      resetBtn.addEventListener('click', function() {
        checkbox.checked = false;
        sigInput.disabled = true;
        sigInput.value = '';
        output.textContent = '';
        output.classList.remove('has-content');
        renderQr('homeQrCanvas', 'homeQrWrap', '');
        showToast('Reset!');
      });
    }

    // ===== SWAP =====
    function initSwap() {
      var fromChain = getEl('fromChainSelect');
      var fromToken = getEl('fromTokenSelect');
      var toChain = getEl('toChainSelect');
      var toToken = getEl('toTokenSelect');
      var amountInput = getEl('amountInput');
      var baseDisplay = getEl('baseUnitsDisplay');
      var checkbox = getEl('swapSignedCheck');
      var sigInput = getEl('swapSigInput');
      var genBtn = getEl('swapGenerateBtn');
      var copyBtn = getEl('swapCopyBtn');
      var qrBtn = getEl('swapQrBtn');
      var resetBtn = getEl('swapResetBtn');
      var output = getEl('swapOutput');

      populateChains(fromChain);
      populateChains(toChain);

      fromChain.value = 'ethereum';
      toChain.value = 'polygon';

      populateTokens(fromToken, fromChain.value);
      populateTokens(toToken, toChain.value);

      fromChain.addEventListener('change', function() {
        populateTokens(fromToken, fromChain.value);
      });

      toChain.addEventListener('change', function() {
        populateTokens(toToken, toChain.value);
      });

      checkbox.addEventListener('change', function() {
        sigInput.disabled = !checkbox.checked;
        if (!checkbox.checked) sigInput.value = '';
      });

      genBtn.addEventListener('click', function() {
        var fc = getChain(fromChain.value);
        var tc = getChain(toChain.value);
        if (!fc || !tc) { showToast('Please select valid chains'); return; }

        var ftTokens = TOKENS[fromChain.value] || [];
        var ttTokens = TOKENS[toChain.value] || [];

        var ftIdx = parseInt(fromToken.value);
        var ttIdx = parseInt(toToken.value);

        if (isNaN(ftIdx) || isNaN(ttIdx) || !ftTokens[ftIdx] || !ttTokens[ttIdx]) {
          showToast('Please select valid tokens');
          return;
        }

        var ft = ftTokens[ftIdx];
        var tt = ttTokens[ttIdx];

        var fromNs = getNamespaceString(fc);
        var toNs = getNamespaceString(tc);

        var fromAsset = getAssetString(ft);
        var toAsset = getAssetString(tt);

        if (!fromAsset || !toAsset) {
          showToast('Invalid asset format for selected tokens');
          return;
        }

        var url = 'https://link.metamask.io/swap?from=' + encodeURIComponent(fromNs + '/' + fromAsset)
                + '&to=' + encodeURIComponent(toNs + '/' + toAsset);

        var amt = amountInput.value;
        if (amt && parseFloat(amt) > 0) {
          var base = toBaseUnits(amt, ft.dec);
          if (!base) { showToast('Invalid amount'); return; }
          baseDisplay.value = base;
          url += '&amount=' + encodeURIComponent(base);
        } else {
          baseDisplay.value = '';
        }

        if (checkbox.checked && sigInput.value.trim()) {
          url += '&sig=' + encodeURIComponent(sigInput.value.trim());
        }

        output.textContent = url;
        output.classList.add('has-content');
        renderQr('swapQrCanvas', 'swapQrWrap', url);
        showToast('Swap deeplink generated!');
      });

      copyBtn.addEventListener('click', function() { copyText(output.textContent); });

      qrBtn.addEventListener('click', function() {
        var url = output.textContent || '';
        if (!url) { showToast('Generate a link first'); return; }
        renderQr('swapQrCanvas', 'swapQrWrap', url);
        showToast('QR ready');
      });

      resetBtn.addEventListener('click', function() {
        fromChain.value = 'ethereum';
        toChain.value = 'polygon';
        populateTokens(fromToken, 'ethereum');
        populateTokens(toToken, 'polygon');
        amountInput.value = '';
        baseDisplay.value = '';
        checkbox.checked = false;
        sigInput.disabled = true;
        sigInput.value = '';
        output.textContent = '';
        output.classList.remove('has-content');
        renderQr('swapQrCanvas', 'swapQrWrap', '');
        showToast('Reset!');
      });
    }

    // ===== BUY =====
    function initBuy() {
      var checkbox = getEl('buySignedCheck');
      var sigInput = getEl('buySigInput');
      var genBtn = getEl('buyGenerateBtn');
      var copyBtn = getEl('buyCopyBtn');
      var qrBtn = getEl('buyQrBtn');
      var resetBtn = getEl('buyResetBtn');
      var output = getEl('buyOutput');

      checkbox.addEventListener('change', function() {
        sigInput.disabled = !checkbox.checked;
        if (!checkbox.checked) sigInput.value = '';
      });

      genBtn.addEventListener('click', function() {
        var url = 'https://link.metamask.io/buy';
        if (checkbox.checked && sigInput.value.trim()) {
          url += '?sig=' + encodeURIComponent(sigInput.value.trim());
        }
        output.textContent = url;
        output.classList.add('has-content');
        renderQr('buyQrCanvas', 'buyQrWrap', url);
        showToast('Buy deeplink generated!');
      });

      copyBtn.addEventListener('click', function() { copyText(output.textContent); });

      qrBtn.addEventListener('click', function() {
        var url = output.textContent || '';
        if (!url) { showToast('Generate a link first'); return; }
        renderQr('buyQrCanvas', 'buyQrWrap', url);
        showToast('QR ready');
      });

      resetBtn.addEventListener('click', function() {
        checkbox.checked = false;
        sigInput.disabled = true;
        sigInput.value = '';
        output.textContent = '';
        output.classList.remove('has-content');
        renderQr('buyQrCanvas', 'buyQrWrap', '');
        showToast('Reset!');
      });
    }

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', function() {
      initHome();
      initSwap();
      initBuy();
    });
  </script>
</body>
</html>
